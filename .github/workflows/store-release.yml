name: Android Store Release

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'client-android/**'
      - '.github/workflows/store-release.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_VERSION: '17'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

           # Decode keystore from secrets (safe shell check)
      - name: Decode keystore
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release.jks
            echo "Keystore decoded to release.jks"
          else
            echo "No ANDROID_KEYSTORE_BASE64 secret found; skipping decode."

      - name: Build AAB (storeRelease)
        working-directory: client-android
        env:
          ANDROID_KEYSTORE: ${{ github.workspace }}/release.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x ./gradlew
          ./gradlew :app:bundleStoreRelease --stacktrace --no-daemon

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-store-release.aab
          path: client-android/app/build/outputs/bundle/storeRelease/app-store-release.aab
